<% content_for(:html_title) { @recipe.name } %>

<h1><%= @recipe.name %></h1>

<div id="info_charts_box">
  <div id="co2_gauge" class="co2_chart">
    <div class="front"></div><div class="back"></div>
    <div class="co2_cell" style='display:inline-block; margin-right: 5px; background-color:<%= @recipe.co2_equiv_color %>'><%= @recipe.co2_equiv_per_serving %></div><strong>CO2e / portion</strong>
    <script>drawGauge(<%=@recipe.co2_equiv_per_serving%>, '<%=@recipe.co2_equiv_color%>');</script>
  </div>

  <div id="daily_budget" class="daily_budget_chart">
    <div class="daily-budget-chart"></div>
    <div style="margin-bottom:3px;"><svg height="11" width="11"><rect class="rect" x="0" y="0" width="11" height="11" fill="rgb(153, 153, 153)"></rect></svg> = 1 portion of <%=@recipe.name%></div>
    You can eat
    <div class="co2_cell" style='display:inline-block; margin-right: 5px; background-color:<%= @recipe.co2_equiv_color %>'><%= (2.7 / @recipe.co2_equiv_per_serving).round(2) %></div> portions of <%=@recipe.name%> to exhaust your <a href="/blogs/75a697d4-fe34-4977-ae2f-b472f1ee02da" target="_blank">daily CO2e food budget</a>
    <script>drawDailyBudget(<%=@recipe.co2_equiv_per_serving%>);</script>
  </div>
</div>

<% if user_signed_in? && current_user.admin? %>
<%= link_to 'Edit recipe', edit_recipe_path(@recipe), class: "green button" %>
<%= link_to 'Delete', @recipe, method: :delete, data: { confirm: 'Are you sure?' }, class: "green button" %>
<% end %>

<p>
  CO2 equivalent ("CO2e") per serving: <strong><span id="recipe-co2e-per-serving"><%= @recipe.co2_equiv_per_serving %></span> kg</strong><br />
  CO2 equivalent ("CO2e"): <span id="recipe-co2e-total"><%= @recipe.co2_equiv %></span> kg
</p>

<p>
  Servings: <%= @recipe.servings %>
</p>

<p>
  Country of consumption: <%= @country_consumption_name %>
</p>

<%= render 'pie_chart' %>

<div class="space_16"></div>

<h2>Ingredients</h2>

<%= form_for(@ingredient) do |f| %>
  <%= f.hidden_field :recipe, value: @recipe.uuid %>

<table id="ingredients_table" class="stripe">
  <thead>
    <tr>
      <th>CO2e (kg)</th>
      <th>Product</th>
      <th>Amount (kg)</th>
      <th>Description</th>
      <th>Country produced</th>
      <% if user_signed_in? && current_user.admin? %>
      <th></th>
      <% end %>
    </tr>
  </thead>
  
  <tbody>
  <% if user_signed_in? && current_user.admin? %>
    <tr>
      <td style="text-align:right;"><% if @ingredient.product %>
          <%= (@ingredient.weight * @ingredient.product.co2_equiv).round(3) %>
          <% else %>
          N/A
          <% end %></td>
      <td><%= f.text_field :product_name, autofocus: true, id: 'product-autocomplete', :required => true %></td>
      <td><%= f.number_field :weight, step: 0.001, :required => true, style: "width:50px" %></td>
      <td><%= f.text_field :description %></td>
      <td><%= f.text_field :country_origin_name, id: 'country-autocomplete-origin', :required => true %></td>
      <td><%= f.submit (@ingredient.product ? 'Update' : 'Add'), class: "green button" %></td>
    </tr>
  <% end %>
  <% @recipe.ingredients.each_with_index do |ingredient, i| %>
    <% if @ingredient != ingredient %> 
    <tr>
      <td>
        <div class="co2_cell" style="float:right; background-color:<%= ingredient.co2_equiv_color(@recipe.servings) %>"><%= ingredient.co2_equiv %></div>
      </td>
      <td><%= link_to ingredient.product.name, ingredient.product, class: ingredient.product.reliability_class %></td>
      <td><%= ingredient.weight %></td>
      <td><%= ingredient.description %></td>
      <td><%= link_to ingredient.country_origin_name, ingredient.country_origin %></td>
      <% if user_signed_in? && current_user.admin? %>
      <td>
        <%= link_to image_tag("modify.png", size: "12x12", alt: "Edit"), params.permit(:edit_ingredient).merge(edit_ingredient: ingredient), remote: true %>
        <%= link_to image_tag("erase.png", size: "12x12", alt: "Remove"), ingredient, method: :delete, data: { confirm: 'Are you sure?' }, remote: true %>
      </td>
      <% end %>
    </tr>
    <% end %>
  <% end %>
  </tbody>
</table>

<% end %>
